name: Daily Brief Runs

on:
  schedule:
    - cron: '0 22 * * *'  # APAC at 22:00 UTC
    - cron: '0 11 * * *'  # International at 11:00 UTC
    - cron: '0 12 * * *'  # International at 12:00 UTC
  workflow_dispatch:
    inputs:
      run_window:
        description: 'Run window (apac or international)'
        required: true
        type: choice
        options:
          - apac
          - international
      region:
        description: 'Region (au or us-mx-la-lng)'
        required: true
        type: choice
        options:
          - au
          - us-mx-la-lng

permissions:
  contents: read

jobs:
  apac:
    if: github.event_name == 'schedule' && github.event.schedule == '0 22 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger APAC brief generation
        shell: bash
        run: |
          set -euo pipefail
          curl -fsS -X POST "${{ secrets.RUNNER_BASE_URL }}/cron" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{"runWindow":"apac","regions":["au"],"scheduled":true}'

  international-11utc:
    if: github.event_name == 'schedule' && github.event.schedule == '0 11 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger International brief generation (11:00 UTC)
        shell: bash
        run: |
          set -euo pipefail
          curl -fsS -X POST "${{ secrets.RUNNER_BASE_URL }}/cron" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{"runWindow":"international","regions":["us-mx-la-lng"],"scheduled":true}'

  international-12utc:
    if: github.event_name == 'schedule' && github.event.schedule == '0 12 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger International brief generation (12:00 UTC)
        shell: bash
        run: |
          set -euo pipefail
          curl -fsS -X POST "${{ secrets.RUNNER_BASE_URL }}/cron" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{"runWindow":"international","regions":["us-mx-la-lng"],"scheduled":true}'

  manual:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger brief generation (manual)
        shell: bash
        run: |
          set -euo pipefail
          RUN_WINDOW="${{ inputs.run_window }}"
          REGION="${{ inputs.region }}"
          PAYLOAD="$(jq -nc --arg runWindow "$RUN_WINDOW" --arg region "$REGION" '{runWindow: $runWindow, regions: [$region], scheduled: true}')"

          curl -fsS -X POST "${{ secrets.RUNNER_BASE_URL }}/cron" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
