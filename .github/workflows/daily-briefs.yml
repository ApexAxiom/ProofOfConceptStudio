name: Daily Briefs

on:
  schedule:
    - cron: '0 6 * * *'  # Runs daily at 6AM UTC
  workflow_dispatch:  # Manual trigger for any region/window as needed

jobs:
  generate-briefs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate Secrets
        run: |
          if [ -z "$MY_SECRET" ]; then
            echo "Error: Missing required secret MY_SECRET"
            exit 1
          fi

      - name: Make API Request (Enhanced Logging)
        run: |
          echo "Starting API call at $(date -u +'%Y-%m-%d %H:%M:%S')"
          RESPONSE=$(curl -s -o response.json -w "%{http_code}" -H "Authorization: Bearer $MY_SECRET" https://api.example.com/endpoint)
          HTTP_CODE=$(tail -n 1 response.json)

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Error: API call failed with HTTP status $HTTP_CODE"
            cat response.json
            exit 1
          fi

          echo "API call succeeded with response:"
          cat response.json

      - name: Save Run State
        uses: actions/upload-artifact@v3
        with:
          name: run-response
          path: response.json

      - name: Enhanced Observability
        env:
          RUN_TIME: $(date -u +'%Y-%m-%d %H:%M:%S')
        run: |
          echo "Run completed at $RUN_TIME" > observability.log
          cat response.json >> observability.log

      - name: Upload Observability Logs
        uses: actions/upload-artifact@v3
        with:
          name: observability-logs
          path: observability.log