name: Generate Daily Intelligence Briefs

on:
  # Run twice daily (CST/CDT - America/Chicago)
  # 6:00 AM CST = 12:00 UTC (winter) / 11:00 UTC (summer)
  # 2:45 PM CST = 20:45 UTC (winter) / 19:45 UTC (summer)
  schedule:
    # AM run - 6:00 AM CST (12:00 UTC)
    - cron: '0 12 * * *'
    # PM run - 2:45 PM CST (20:45 UTC)
    - cron: '45 20 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      region:
        description: 'Region to run (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - au
          - us-mx-la-lng

env:
  PNPM_VERSION: 9.12.0
  NODE_VERSION: '20'

jobs:
  generate-briefs-au:
    name: Generate AU Briefs
    runs-on: ubuntu-latest
    if: github.event.inputs.region == '' || github.event.inputs.region == 'au'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        run: pnpm --filter @proof/shared build

      - name: Run AU agents
        working-directory: apps/runner
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-4o-mini' }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          DDB_TABLE_NAME: ${{ secrets.DDB_TABLE_NAME || 'CMHub' }}
        run: |
          echo "üöÄ Starting AU region brief generation..."
          npx tsx src/cli.ts run apac --region au
          echo "‚úÖ AU briefs complete"

      - name: Log completion
        run: |
          echo "üìù Completed AU brief generation"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

  generate-briefs-international:
    name: Generate International Briefs
    runs-on: ubuntu-latest
    if: github.event.inputs.region == '' || github.event.inputs.region == 'us-mx-la-lng'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        run: pnpm --filter @proof/shared build

      - name: Run International agents
        working-directory: apps/runner
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-4o-mini' }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          DDB_TABLE_NAME: ${{ secrets.DDB_TABLE_NAME || 'CMHub' }}
        run: |
          echo "üöÄ Starting International region brief generation..."
          npx tsx src/cli.ts run international --region us-mx-la-lng
          echo "‚úÖ International briefs complete"

      - name: Log completion
        run: |
          echo "üìù Completed International brief generation"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

  summary:
    name: Brief Generation Summary
    runs-on: ubuntu-latest
    needs: [generate-briefs-au, generate-briefs-international]
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "üìä Brief Generation Summary"
          echo "=========================="
          
          AU_RESULT="${{ needs.generate-briefs-au.result }}"
          INTL_RESULT="${{ needs.generate-briefs-international.result }}"
          
          echo "AU Region: $AU_RESULT"
          echo "International Region: $INTL_RESULT"
          
          if [ "$AU_RESULT" = "success" ] || [ "$AU_RESULT" = "skipped" ]; then
            echo "‚úÖ AU: OK"
          else
            echo "‚ùå AU: Failed"
          fi
          
          if [ "$INTL_RESULT" = "success" ] || [ "$INTL_RESULT" = "skipped" ]; then
            echo "‚úÖ International: OK"
          else
            echo "‚ùå International: Failed"
          fi
          
          if [ "$AU_RESULT" = "failure" ] || [ "$INTL_RESULT" = "failure" ]; then
            echo ""
            echo "‚ö†Ô∏è  Some regions failed. Check job logs for details."
            exit 1
          fi
          
          echo ""
          echo "‚ú® All regions completed successfully!"
